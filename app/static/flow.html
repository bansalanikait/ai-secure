<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Flow Graph - SecureCode AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --panel:#07162a;
      --panel-2:#081f2f;
      --line:#12344f;
      --text:#e6eef8;
      --muted:#a9bfd6;
      --blue:#2f7ed8;
      --orange:#f29f38;
      --red:#df4a4a;
      --ok:#7dd3fc;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial;margin:0;background:var(--bg);color:var(--text)}
    .nav{background:#061426;padding:12px 20px;display:flex;gap:14px}
    .nav a{color:#9fd0ff;text-decoration:none}
    .container{max-width:1280px;margin:0 auto;padding:18px}
    .controls{display:grid;grid-template-columns:minmax(220px,1fr) minmax(220px,1fr) auto auto auto;gap:10px;align-items:center}
    .controls input,.controls button{height:42px;border:1px solid var(--line);border-radius:8px;background:#0d2238;color:var(--text);padding:0 12px}
    .controls button{cursor:pointer;font-weight:600}
    .controls label{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    .status{margin-top:10px;color:var(--muted);min-height:20px}
    .scan-panel{margin-top:14px}
    .scan-meta{padding:12px 14px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px}
    .scan-tile{background:#0a1e33;border:1px solid #173553;border-radius:8px;padding:8px}
    .scan-findings{padding:12px 14px;max-height:220px;overflow:auto}
    .scan-actions{padding:0 14px 12px 14px;display:flex;gap:10px;flex-wrap:wrap}
    .scan-actions a{color:#9fd0ff;text-decoration:none}
    .layout{margin-top:14px;display:grid;grid-template-columns:2fr 1fr;gap:14px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:15px}
    .graph-wrap{height:68vh;min-height:420px;position:relative}
    #graph{width:100%;height:100%}
    .legend{position:absolute;right:10px;top:10px;background:#061426cc;border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}
    .details{padding:12px 14px;font-size:14px;line-height:1.45;max-height:68vh;overflow:auto}
    .kv{margin:8px 0}
    .pill{display:inline-block;background:#10324b;border:1px solid #194a6e;color:#b8dbff;border-radius:999px;padding:2px 8px;margin:0 6px 6px 0;font-size:12px}
    .vuln{background:var(--panel-2);border:1px solid #194a6e;border-radius:8px;padding:8px;margin-bottom:8px}
    .finding-title{font-size:15px;line-height:1.3}
    .finding-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .finding-meta .pill{margin:0}
    .payload-list{margin:6px 0 0 14px;padding:0}
    .payload-list li{margin:3px 0;word-break:break-word}
    .ai-block{margin-top:8px}
    .mitigation-box{
      margin-top:6px;
      padding:8px;
      border:1px solid #23b26d;
      border-radius:8px;
      background:rgba(35,178,109,0.08);
    }
    .small{font-size:12px;color:var(--muted)}
    .err{color:#ff9696}
    @media (max-width:980px){
      .layout{grid-template-columns:1fr}
      .graph-wrap,.details{max-height:none}
    }
    @media (max-width:720px){
      .controls{grid-template-columns:1fr}
      .controls button{width:100%}
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="/static/index.html">Scan</a>
    <a href="/static/history.html">History</a>
    <a href="/static/flow.html">Flow</a>
  </div>
  <div class="container">
    <div class="controls">
      <input id="target-url" type="url" placeholder="https://example.com" />
      <input id="api-base" type="url" placeholder="Backend URL (optional, e.g. http://127.0.0.1:8000)" />
      <button id="run">Crawl & Visualize</button>
      <button id="run-full">Full Web Scan</button>
      <label><input id="overlay" type="checkbox" checked /> Run /fuzz overlay</label>
    </div>
    <div id="status" class="status"></div>
    <div id="scan-panel" class="panel scan-panel" style="display:none">
      <h3>Full Web Scan Summary</h3>
      <div id="scan-meta" class="scan-meta"></div>
      <div id="scan-actions" class="scan-actions"></div>
      <div id="scan-findings" class="scan-findings"></div>
    </div>

    <div class="layout">
      <div class="panel">
        <h3>Application Flow Graph</h3>
        <div class="graph-wrap">
          <svg id="graph" aria-label="Flow Graph"></svg>
          <div class="legend">
            <div><span class="dot" style="background:var(--blue)"></span>Normal</div>
            <div><span class="dot" style="background:var(--orange)"></span>Vulnerability Node</div>
            <div><span class="dot" style="background:var(--red)"></span>Stored Chain Node</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h3>Node Details</h3>
        <div id="details" class="details">Click a node to inspect URL, parameters, and vulnerabilities.</div>
      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const detailsEl = document.getElementById("details");
    const svgEl = document.getElementById("graph");
    const overlayEl = document.getElementById("overlay");
    const targetUrlEl = document.getElementById("target-url");
    const apiBaseEl = document.getElementById("api-base");
    const scanPanelEl = document.getElementById("scan-panel");
    const scanMetaEl = document.getElementById("scan-meta");
    const scanFindingsEl = document.getElementById("scan-findings");
    const scanActionsEl = document.getElementById("scan-actions");
    const API_BASE_STORAGE_KEY = "ai_secure_api_base";
    let currentGraph = null;
    let currentFuzz = null;
    let currentNodeVulns = new Map();
    let currentReflections = new Map();

    function normalizeBaseUrl(value) {
      const raw = String(value || "").trim();
      if (!raw) return "";
      return raw.replace(/\/+$/, "");
    }

    function getDefaultApiBase() {
      const saved = normalizeBaseUrl(localStorage.getItem(API_BASE_STORAGE_KEY) || "");
      if (saved) return saved;
      if (window.location.protocol === "file:") return "http://127.0.0.1:8000";
      return "";
    }

    function currentApiBase() {
      return normalizeBaseUrl(apiBaseEl?.value || "");
    }

    function apiUrl(path) {
      const base = currentApiBase();
      if (!base) return path;
      return `${base}${path}`;
    }

    function updateApiBaseFromInput() {
      const normalized = normalizeBaseUrl(apiBaseEl?.value || "");
      if (!apiBaseEl) return;
      apiBaseEl.value = normalized;
      if (normalized) {
        localStorage.setItem(API_BASE_STORAGE_KEY, normalized);
      } else {
        localStorage.removeItem(API_BASE_STORAGE_KEY);
      }
    }

    function buildUiUrl(path) {
      const base = currentApiBase();
      if (!base) return path;
      return `${base}${path}`;
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function normalizeUrl(url) {
      try {
        const u = new URL(String(url || ""));
        u.hash = "";
        u.search = "";
        return u.toString().replace(/\/$/, "");
      } catch (_) {
        return String(url || "").trim();
      }
    }

    async function parseJsonResponse(res) {
      let body = {};
      try {
        body = await res.json();
      } catch (_) {
        body = {};
      }
      if (!res.ok) throw new Error(body.detail || "Request failed");
      return body;
    }

    function webScanToFuzzLike(scanData, fallbackTargetUrl = "") {
      const findings = Array.isArray(scanData?.findings) ? scanData.findings : [];
      const normalizedFindings = findings.map((f) => ({
        ...f,
        target_url: f.target_url || fallbackTargetUrl || ""
      }));
      return {
        findings: normalizedFindings,
        cross_page_reflections: Array.isArray(scanData?.cross_page_reflections)
          ? scanData.cross_page_reflections
          : []
      };
    }

    function humanizeVulnerabilityName(type) {
      const raw = String(type || "").trim();
      if (!raw) return "Potential Issue";
      const predefined = {
        sql_injection: "SQL Injection",
        xss: "Cross-Site Scripting (XSS)",
        command_injection: "Command Injection",
        path_traversal: "Path Traversal"
      };
      const key = raw.toLowerCase().replace(/\s+/g, "_");
      if (predefined[key]) return predefined[key];
      return raw
        .replace(/[_-]+/g, " ")
        .replace(/\b\w/g, (ch) => ch.toUpperCase());
    }

    function findingPayloadExamples(finding) {
      if (Array.isArray(finding?.payload_examples) && finding.payload_examples.length) {
        return finding.payload_examples.filter((p) => String(p || "").trim() !== "");
      }
      if (finding?.payload) return [finding.payload];
      return [];
    }

    function renderFullScanSummary(scanData) {
      if (!scanData || typeof scanData !== "object") {
        scanPanelEl.style.display = "none";
        return;
      }
      scanPanelEl.style.display = "block";
      const reportId = String(scanData.report_id || "");
      const score = Number(scanData.security_score ?? 0);
      const grade = String(scanData.grade || "-");
      const totalPages = Number(scanData.total_pages ?? 0);
      const totalParams = Number(scanData.total_parameters ?? 0);
      const totalFindings = Number(scanData.total_findings ?? 0);
      const stored = Number(scanData.stored_vulnerability_candidates ?? 0);
      const longest = scanData.longest_parameter_chain || {};
      const longestLen = Number(longest.chain_length ?? 0);
      const longestParam = String(longest.parameter || "-");

      scanMetaEl.innerHTML = `
        <div class="scan-tile"><div class="small">Security Score</div><b>${escapeHtml(score)}</b></div>
        <div class="scan-tile"><div class="small">Grade</div><b>${escapeHtml(grade)}</b></div>
        <div class="scan-tile"><div class="small">Pages</div><b>${escapeHtml(totalPages)}</b></div>
        <div class="scan-tile"><div class="small">Parameters</div><b>${escapeHtml(totalParams)}</b></div>
        <div class="scan-tile"><div class="small">Findings</div><b>${escapeHtml(totalFindings)}</b></div>
        <div class="scan-tile"><div class="small">Stored Candidates</div><b>${escapeHtml(stored)}</b></div>
        <div class="scan-tile"><div class="small">Longest Chain</div><b>${escapeHtml(longestLen)}</b></div>
        <div class="scan-tile"><div class="small">Chain Parameter</div><b>${escapeHtml(longestParam)}</b></div>
      `;

      scanActionsEl.innerHTML = reportId
        ? `
            <a href="${escapeHtml(buildUiUrl(`/static/history.html?open=${encodeURIComponent(reportId)}`))}">View Report</a>
            <a href="${escapeHtml(buildUiUrl(`/report/${encodeURIComponent(reportId)}/pdf`))}" target="_blank" rel="noopener">Download PDF</a>
          `
        : "";

      const findings = Array.isArray(scanData.findings) ? scanData.findings : [];
      if (!findings.length) {
        scanFindingsEl.innerHTML = `<div class="small">No findings from full scan.</div>`;
        return;
      }
      scanFindingsEl.innerHTML = findings.map((f) => {
        const ai = f.ai_explanation || {};
        const summary = ai.executive_summary ? String(ai.executive_summary) : "";
        const mitigation = ai.recommended_mitigation ? String(ai.recommended_mitigation) : "";
        const payloadExamples = findingPayloadExamples(f);
        const vulnName = humanizeVulnerabilityName(f.vulnerability_type);
        return `
          <div class="vuln">
            <div class="finding-title"><b>${escapeHtml(vulnName)}</b></div>
            <div class="small">parameter: <code>${escapeHtml(f.parameter || "-")}</code></div>
            <div class="finding-meta">
              <span class="pill">CWE: ${escapeHtml(f.cwe_id || "-")}</span>
              <span class="pill">OWASP: ${escapeHtml(f.owasp_category || "-")}</span>
              <span class="pill">Severity: ${escapeHtml(f.severity || "Info")}</span>
              <span class="pill">Confidence: ${escapeHtml(f.confidence_score ?? "-")}</span>
            </div>
            <details class="small">
              <summary>Payload Examples (${escapeHtml(payloadExamples.length)})</summary>
              ${
                payloadExamples.length
                  ? `<ul class="payload-list">${payloadExamples.map((p) => `<li><code>${escapeHtml(p)}</code></li>`).join("")}</ul>`
                  : `<div>No payload examples.</div>`
              }
            </details>
            ${
              summary || mitigation
                ? `
                  <div class="ai-block">
                    ${summary ? `<div class="small"><b>Executive Summary:</b> ${escapeHtml(summary)}</div>` : ""}
                    ${mitigation ? `<div class="mitigation-box small"><b>Recommended Mitigation:</b> ${escapeHtml(mitigation)}</div>` : ""}
                  </div>
                `
                : ""
            }
          </div>
        `;
      }).join("");
    }

    async function getFlowGraphFromReport(reportId, targetUrl) {
      if (reportId) {
        try {
          const reportRes = await fetch(apiUrl(`/history/${encodeURIComponent(reportId)}`));
          const reportData = await parseJsonResponse(reportRes);
          const graph = reportData?.crawl_output?.flow_graph;
          if (graph && Array.isArray(graph.nodes)) {
            return graph;
          }
        } catch (_) {
          // Fall back to direct crawl below.
        }
      }

      const crawlRes = await fetch(apiUrl("/crawl"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target_url: targetUrl })
      });
      const crawlData = await parseJsonResponse(crawlRes);
      return crawlData.flow_graph || flowGraphFallback(crawlData);
    }

    function flowGraphFallback(crawlData) {
      const pages = Array.isArray(crawlData?.pages) ? crawlData.pages : [];
      const nodes = pages.map((p) => ({
        url: p.url,
        depth: p.depth || 0,
        response_type: p.response_type || "unknown",
        parameters: Array.isArray(p.query_parameters) ? p.query_parameters : []
      }));
      const edges = [];
      for (const page of pages) {
        const src = page?.url;
        if (!src) continue;
        const links = Array.isArray(page.internal_links) ? page.internal_links : [];
        for (const dst of links) {
          edges.push({
            source_url: src,
            destination_url: dst,
            parameter_name: "",
            method: "GET",
            example_value: ""
          });
        }
      }
      return { nodes, edges };
    }

    function buildNodeVulnerabilityMap(fuzzData) {
      const map = new Map();
      const findings = Array.isArray(fuzzData?.findings) ? fuzzData.findings : [];

      for (const f of findings) {
        const key = normalizeUrl(f.target_url);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(f);

        const chains = Array.isArray(f.flow_chain_evidence) ? f.flow_chain_evidence : [];
        for (const chain of chains) {
          const path = Array.isArray(chain.path) ? chain.path : [];
          for (const nodeUrl of path) {
            const k = normalizeUrl(nodeUrl);
            if (!map.has(k)) map.set(k, []);
            map.get(k).push(f);
          }
        }
      }
      return map;
    }

    function buildReflectionMap(fuzzData) {
      const map = new Map();
      const reflections = Array.isArray(fuzzData?.cross_page_reflections) ? fuzzData.cross_page_reflections : [];
      for (const r of reflections) {
        const sourceKey = normalizeUrl(r.source);
        const sinkKey = normalizeUrl(r.sink);
        if (!map.has(sourceKey)) map.set(sourceKey, []);
        if (!map.has(sinkKey)) map.set(sinkKey, []);
        map.get(sourceKey).push({ ...r, role: "source" });
        map.get(sinkKey).push({ ...r, role: "sink" });
      }
      return map;
    }

    function classifyNode(url, fuzzData) {
      const norm = normalizeUrl(url);
      const reflections = Array.isArray(fuzzData?.cross_page_reflections) ? fuzzData.cross_page_reflections : [];
      const reflectionSet = new Set();
      for (const r of reflections) {
        reflectionSet.add(normalizeUrl(r.source));
        reflectionSet.add(normalizeUrl(r.sink));
        const chain = Array.isArray(r.flow_chain) ? r.flow_chain : [];
        for (const n of chain) reflectionSet.add(normalizeUrl(n));
      }

      if (reflectionSet.has(norm)) return "stored";
      if (currentNodeVulns.has(norm) && currentNodeVulns.get(norm).length) return "vuln";
      return "normal";
    }

    function renderNodeDetails(node) {
      if (!node) {
        detailsEl.innerHTML = "Click a node to inspect URL, parameters, and vulnerabilities.";
        return;
      }

      const norm = normalizeUrl(node.url);
      const vulnerabilities = currentNodeVulns.get(norm) || [];
      const reflections = currentReflections.get(norm) || [];
      const params = Array.isArray(node.parameters) ? node.parameters : [];

      const paramsHtml = params.length
        ? params.map((p) => `<span class="pill">${escapeHtml(p)}</span>`).join("")
        : `<span class="small">No parameters found.</span>`;

      const vulnHtml = vulnerabilities.length
        ? vulnerabilities.map((v) => `
            <div class="vuln">
              <div><b>${escapeHtml(v.vulnerability_type || "Potential issue")}</b></div>
              <div class="small">severity=${escapeHtml(v.severity || "Info")} | confidence=${escapeHtml(v.confidence_score ?? "-")}</div>
              ${v.payload ? `<div class="small">payload: <code>${escapeHtml(v.payload)}</code></div>` : ""}
              ${v.evidence_snippet ? `<div class="small">${escapeHtml(v.evidence_snippet)}</div>` : ""}
            </div>
          `).join("")
        : `<div class="small">No vulnerabilities mapped to this node.</div>`;

      const reflectionHtml = reflections.length
        ? reflections.map((r) => {
            const flowChain = Array.isArray(r.flow_chain) ? r.flow_chain : [];
            return `
              <div class="vuln">
                <div><b>Stored Reflection Candidate (${escapeHtml(r.role)})</b></div>
                <div class="small">payload=${escapeHtml(r.payload_marker || "-")} | status=${escapeHtml(r.response_status ?? "-")}</div>
                ${flowChain.length ? `<div class="small">flow: ${escapeHtml(flowChain.join(" -> "))}</div>` : ""}
              </div>
            `;
          }).join("")
        : `<div class="small">No stored-chain reflections on this node.</div>`;

      detailsEl.innerHTML = `
        <div class="kv"><b>URL</b><br>${escapeHtml(node.url)}</div>
        <div class="kv"><b>Depth</b>: ${escapeHtml(node.depth ?? 0)} | <b>Type</b>: ${escapeHtml(node.response_type || "unknown")}</div>
        <div class="kv"><b>Parameters</b><br>${paramsHtml}</div>
        <div class="kv"><b>Vulnerabilities Detected</b></div>
        ${vulnHtml}
        <div class="kv"><b>Stored Vulnerability Chains</b></div>
        ${reflectionHtml}
      `;
    }

    function renderGraph(flowGraph, fuzzData) {
      const graph = flowGraph && Array.isArray(flowGraph.nodes) ? flowGraph : { nodes: [], edges: [] };
      const nodes = graph.nodes.map((n) => ({
        ...n,
        id: n.url,
        status: classifyNode(n.url, fuzzData)
      }));
      const nodeById = new Map(nodes.map((n) => [n.id, n]));
      const links = (graph.edges || [])
        .map((e) => ({
          source: e.source_url,
          target: e.destination_url,
          parameter_name: e.parameter_name || "",
          method: e.method || "GET"
        }))
        .filter((e) => nodeById.has(e.source) && nodeById.has(e.target));

      const width = svgEl.clientWidth || 900;
      const height = svgEl.clientHeight || 560;
      const svg = d3.select(svgEl);
      svg.selectAll("*").remove();
      svg.attr("viewBox", `0 0 ${width} ${height}`);

      const defs = svg.append("defs");
      defs.append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 20)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#3d78b0");

      const root = svg.append("g");
      const zoom = d3.zoom().scaleExtent([0.35, 3]).on("zoom", (event) => root.attr("transform", event.transform));
      svg.call(zoom);

      const link = root.append("g")
        .attr("stroke", "#3d78b0")
        .attr("stroke-opacity", 0.8)
        .selectAll("line")
        .data(links)
        .enter()
        .append("line")
        .attr("stroke-width", 1.4)
        .attr("marker-end", "url(#arrow)");

      const linkLabel = root.append("g")
        .selectAll("text")
        .data(links.filter((l) => l.parameter_name))
        .enter()
        .append("text")
        .attr("font-size", 10)
        .attr("fill", "#9fc5e8")
        .text((d) => `${d.method}:${d.parameter_name}`);

      const color = (status) => status === "stored" ? "var(--red)" : status === "vuln" ? "var(--orange)" : "var(--blue)";

      const node = root.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter()
        .append("circle")
        .attr("r", 11)
        .attr("fill", (d) => color(d.status))
        .attr("stroke", "#dbeafe")
        .attr("stroke-width", 1)
        .on("click", (_, d) => renderNodeDetails(d))
        .call(d3.drag()
          .on("start", (event, d) => {
            if (!event.active) sim.alphaTarget(0.35).restart();
            d.fx = d.x;
            d.fy = d.y;
          })
          .on("drag", (event, d) => {
            d.fx = event.x;
            d.fy = event.y;
          })
          .on("end", (event, d) => {
            if (!event.active) sim.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }));

      const labels = root.append("g")
        .selectAll("text")
        .data(nodes)
        .enter()
        .append("text")
        .attr("font-size", 11)
        .attr("fill", "#dbeafe")
        .attr("dx", 14)
        .attr("dy", 4)
        .text((d) => {
          try {
            const u = new URL(d.url);
            return u.pathname && u.pathname !== "/" ? u.pathname : u.hostname;
          } catch (_) {
            return d.url;
          }
        });

      const sim = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id((d) => d.id).distance(115).strength(0.65))
        .force("charge", d3.forceManyBody().strength(-460))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide(26));

      sim.on("tick", () => {
        link
          .attr("x1", (d) => d.source.x)
          .attr("y1", (d) => d.source.y)
          .attr("x2", (d) => d.target.x)
          .attr("y2", (d) => d.target.y);
        node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
        labels.attr("x", (d) => d.x).attr("y", (d) => d.y);
        linkLabel
          .attr("x", (d) => (d.source.x + d.target.x) / 2)
          .attr("y", (d) => (d.source.y + d.target.y) / 2);
      });

      if (nodes.length) renderNodeDetails(nodes[0]);
    }

    async function runFlow() {
      const targetUrl = targetUrlEl.value.trim();
      if (!targetUrl) {
        statusEl.innerHTML = `<span class="err">Enter a target URL.</span>`;
        return;
      }
      statusEl.textContent = "Crawling target...";
      detailsEl.textContent = "Loading...";
      currentFuzz = null;
      currentNodeVulns = new Map();
      currentReflections = new Map();

      try {
        const crawlRes = await fetch(apiUrl("/crawl"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target_url: targetUrl })
        });
        const crawlData = await parseJsonResponse(crawlRes);
        const flowGraph = crawlData.flow_graph || flowGraphFallback(crawlData);
        currentGraph = flowGraph;

        if (overlayEl.checked) {
          statusEl.textContent = "Running fuzz overlay...";
          const fuzzRes = await fetch(apiUrl("/fuzz"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(crawlData)
          });
          currentFuzz = await parseJsonResponse(fuzzRes);
          currentNodeVulns = buildNodeVulnerabilityMap(currentFuzz);
          currentReflections = buildReflectionMap(currentFuzz);
        } else {
          currentNodeVulns = new Map();
          currentReflections = new Map();
        }

        renderGraph(currentGraph, currentFuzz);
        const nodeCount = Array.isArray(currentGraph.nodes) ? currentGraph.nodes.length : 0;
        const edgeCount = Array.isArray(currentGraph.edges) ? currentGraph.edges.length : 0;
        const findingCount = Array.isArray(currentFuzz?.findings) ? currentFuzz.findings.length : 0;
        statusEl.textContent = `Graph loaded: ${nodeCount} nodes, ${edgeCount} edges${currentFuzz ? `, ${findingCount} findings` : ""}.`;
      } catch (err) {
        statusEl.innerHTML = `<span class="err">Failed: ${escapeHtml(err.message || err)}</span>`;
        detailsEl.textContent = "Unable to render graph.";
      }
    }

    async function runFullScan() {
      const targetUrl = targetUrlEl.value.trim();
      if (!targetUrl) {
        statusEl.innerHTML = `<span class="err">Enter a target URL.</span>`;
        return;
      }

      statusEl.textContent = "Running full website scan (crawl + fuzz + AI explanation)...";
      detailsEl.textContent = "Loading full scan...";
      scanPanelEl.style.display = "none";
      currentFuzz = null;
      currentNodeVulns = new Map();
      currentReflections = new Map();

      try {
        const scanRes = await fetch(apiUrl("/scan-website"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target_url: targetUrl })
        });
        const scanData = await parseJsonResponse(scanRes);
        renderFullScanSummary(scanData);

        const reportId = String(scanData.report_id || "");
        currentGraph = await getFlowGraphFromReport(reportId, targetUrl);
        currentFuzz = webScanToFuzzLike(scanData, targetUrl);
        currentNodeVulns = buildNodeVulnerabilityMap(currentFuzz);
        currentReflections = buildReflectionMap(currentFuzz);
        renderGraph(currentGraph, currentFuzz);

        const nodeCount = Array.isArray(currentGraph?.nodes) ? currentGraph.nodes.length : 0;
        const edgeCount = Array.isArray(currentGraph?.edges) ? currentGraph.edges.length : 0;
        const findingCount = Array.isArray(scanData?.findings) ? scanData.findings.length : 0;
        statusEl.textContent = `Full scan complete: score=${scanData.security_score}, grade=${scanData.grade}, ${nodeCount} nodes, ${edgeCount} edges, ${findingCount} findings.`;
      } catch (err) {
        statusEl.innerHTML = `<span class="err">Full scan failed: ${escapeHtml(err.message || err)}</span>`;
        detailsEl.textContent = "Unable to render full scan results.";
      }
    }

    document.getElementById("run").addEventListener("click", runFlow);
    document.getElementById("run-full").addEventListener("click", runFullScan);
    apiBaseEl.addEventListener("change", updateApiBaseFromInput);
    apiBaseEl.addEventListener("blur", updateApiBaseFromInput);
    targetUrlEl.addEventListener("keydown", (e) => { if (e.key === "Enter") runFlow(); });
    window.addEventListener("resize", () => { if (currentGraph) renderGraph(currentGraph, currentFuzz); });

    apiBaseEl.value = getDefaultApiBase();
    updateApiBaseFromInput();
    if (window.location.protocol === "file:") {
      statusEl.textContent = "Set Backend URL (default http://127.0.0.1:8000) and keep FastAPI running.";
    }
  </script>
</body>
</html>
