import re
from typing import Dict

_EMPTY_TAXONOMY = {
    "owasp_category": "",
    "cwe_id": "",
}

_TAXONOMY_MAP = {
    "sql_injection": {
        "owasp_category": "A03:2021 - Injection",
        "cwe_id": "CWE-89",
    },
    "xss": {
        "owasp_category": "A03:2021 - Injection",
        "cwe_id": "CWE-79",
    },
    "command_injection": {
        "owasp_category": "A03:2021 - Injection",
        "cwe_id": "CWE-78",
    },
    "path_traversal": {
        "owasp_category": "A01:2021 - Broken Access Control",
        "cwe_id": "CWE-22",
    },
}


def _normalize_text(value: str) -> str:
    text = re.sub(r"[^a-z0-9]+", " ", str(value or "").lower()).strip()
    return re.sub(r"\s+", " ", text)


def _canonical_vulnerability_type(vulnerability_type: str) -> str:
    text = _normalize_text(vulnerability_type)
    if not text:
        return ""

    if ("sql" in text and "inject" in text) or text == "sqli":
        return "sql_injection"
    if text == "xss" or "cross site scripting" in text:
        return "xss"
    if "command" in text and "inject" in text:
        return "command_injection"
    if "path" in text and "travers" in text:
        return "path_traversal"
    return ""


def get_vulnerability_taxonomy(vulnerability_type: str) -> Dict[str, str]:
    canonical = _canonical_vulnerability_type(vulnerability_type)
    if not canonical:
        return dict(_EMPTY_TAXONOMY)
    return dict(_TAXONOMY_MAP.get(canonical, _EMPTY_TAXONOMY))


__all__ = ["get_vulnerability_taxonomy"]
